<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TheRewrite</title>
        <meta name="description" content="Annotations but creative">
        <meta name="author" content="The Rewrite Team @ FHNW">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200;0,6..12,300;0,6..12,400;0,6..12,500;0,6..12,600;0,6..12,700;0,6..12,800;0,6..12,900;0,6..12,1000;1,6..12,200;1,6..12,300;1,6..12,400;1,6..12,500;1,6..12,600;1,6..12,700;1,6..12,800;1,6..12,900;1,6..12,1000&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/style/basic.css">
        <link rel="stylesheet" type="text/css" href="/style/viewer.css">
        <link rel="stylesheet" type="text/css" href="/style/workspace.css">
        <script src="/script/pdf.min.js" type="text/javascript"></script>
        <script src="/script/interact.min.js" type="text/javascript"></script>

    </head>
    <body>
        <nav id="nav">
            <a href="/" id="nav-title">TheRewrite</a>
        </nav>
        <nav id="toolbar">
            <div class="tool add-post-it" id="add-post-it-green">+</div>
            <div class="tool add-post-it" id="add-post-it-yellow">+</div>
            <div class="tool add-post-it" id="add-post-it-red">+</div>
        </nav>
        <section id="workspace">
            <div id="viewer"></div>
            <div id="noteboard"></div>
        </section>
        <script> /* PDF Viewer Script */

            const { pdfjsLib } = globalThis;

            pdfjsLib.GlobalWorkerOptions.workerSrc = '/script/pdf.worker.min.js';

            window.onload = () => {
                let path = window.location.pathname;
                let pathArr = path.split("/");

                let viewer = document.querySelector("#viewer");

                let loadingTask = pdfjsLib.getDocument("/pdf/get/" + pathArr[pathArr.length - 1]);

                loadingTask.promise
                    .then((pdf) => {

                        for(let i = 0; i <= pdf.numPages; i++) {
                            renderPage(pdf, viewer, i);
                        }

                    })
                    .catch(() => {
                        window.location.replace("/");
                    });
            }

            function renderPage(pdf, viewer, pageNr) {
                pdf.getPage(pageNr).then((page) => {
                    const scale = 3;
                    let viewport = page.getViewport({ scale: scale, });
                    let outputScale = window.devicePixelRatio || 1;

                    let canvas = document.createElement("canvas")
                    let context = canvas.getContext('2d');

                    canvas.id = "viewer-page-" + pageNr;
                    canvas.className = "viewer-page";
                    canvas.width = Math.floor(viewport.width * outputScale);
                    canvas.height = Math.floor(viewport.height * outputScale);

                    let transform = outputScale !== 1
                        ? [outputScale, 0, 0, outputScale, 0, 0]
                        : null;

                    let renderContext = {
                        canvasContext: context,
                        transform: transform,
                        viewport: viewport
                    };
                    page.render(renderContext);

                    viewer.appendChild(canvas);
                });
            }
        </script>
        <script> /* Drag and Drop Script */

            //scale     // scale to screen size      // round up to next 0.2 increment
            let scale = (window.innerWidth / 2400) - ((window.innerWidth / 2400) % 0.2) + 0.2;
            let workspace = document.getElementById("workspace");
            let noteboard = document.getElementById("noteboard"); // needed for restriction of drag and drops
            let navbar = document.getElementById("nav");

            let addingColor = null;

            // set a initial scale
            workspace.style.transform = `scale(${scale})`;

            interact('.post-it')
                .draggable({
                    modifiers: [
                        interact.modifiers.snap({
                            targets: [
                                interact.snappers.grid({ x: 16, y: 16 })
                            ],
                            range: Infinity,
                            relativePoints: [ { x: 0, y: 0 } ]
                        }),
                        interact.modifiers.restrict({
                            restriction: noteboard,
                            elementRect: { top: 0, left: 0, bottom: 1, right: 1 },
                            endOnly: true
                        })
                    ],
                    listeners: {
                        move: (event) => {

                            // Grid Elements have offset attributes to save their current translation
                            let x = Number(event.target.getAttribute("offset-x"));
                            let y = Number(event.target.getAttribute("offset-y"));

                            // transform: scale() doesn't change width, but viewport. Apply scale to match it
                            x += event.dx / scale;
                            y += event.dy / scale;

                            event.target.setAttribute("offset-x", x);
                            event.target.setAttribute("offset-y", y);
                            event.target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
                        }
                    },
                    inertia: true
                });

            // scroll to the middle of the screen on load
            document.body.scrollLeft = (document.body.scrollWidth - document.body.clientWidth) / 2

            // adjusts scale based on key input
            document.addEventListener("keydown", (event) => {
                if (event.keyCode === 38) { // Arrow Up
                    scale += 0.2;
                    workspace.style.transform = `scale(${scale})`;
                }
                if (event.keyCode === 40 && scale > 0.41) { // Arrow Down
                    scale -= 0.2;
                    workspace.style.transform = `scale(${scale})`;
                }
            });

            // add eventlistener to add button
            document.getElementById("add-post-it-green").addEventListener("click", (e) => {
                addingColor = "green";
            });
            document.getElementById("add-post-it-yellow").addEventListener("click", (e) => {
                addingColor = "yellow";
            });
            document.getElementById("add-post-it-red").addEventListener("click", (e) => {
                addingColor = "red";
            });

            // if you click the canvas...
            noteboard.addEventListener("click", (e) => {
                if(addingColor != null) { // ...and clicked the add button before

                    let postIt = document.createElement("div");
                    let x = 0;
                    let y = (0 - (noteboard.childElementCount * 160)); // for each already existing element, offset it by their height (so it starts at 0)

                    let svg = document.createElement("img");
                    postIt.classList = ["post-it-svg"];
                    svg.src = `/media/icons/post-it-${addingColor}.svg`;
                    addingColor = null;

                    postIt.appendChild(svg);

                    // the amount scrolled + distance from viewport edge to the mouse
                    x += (document.body.scrollLeft + e.clientX) / scale;
                    y += (document.body.scrollTop + e.clientY - navbar.offsetHeight) / scale; // also add navbar height

                    postIt.setAttribute("offset-x", x);
                    postIt.setAttribute("offset-y", y);
                    postIt.style.transform = `translate(${x}px, ${y}px)`;
                    postIt.classList = ["post-it"];

                    noteboard.appendChild(postIt);
                }
            });
        </script>
    </body>
</html>
