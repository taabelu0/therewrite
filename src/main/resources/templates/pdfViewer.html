<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TheRewrite</title>
        <meta name="description" content="Annotations but creative">
        <meta name="author" content="The Rewrite Team @ FHNW">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200;0,6..12,300;0,6..12,400;0,6..12,500;0,6..12,600;0,6..12,700;0,6..12,800;0,6..12,900;0,6..12,1000;1,6..12,200;1,6..12,300;1,6..12,400;1,6..12,500;1,6..12,600;1,6..12,700;1,6..12,800;1,6..12,900;1,6..12,1000&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/style/basic.css">
        <link rel="stylesheet" type="text/css" href="/style/viewer.css">
        <script src="/script/pdf.min.js" type="text/javascript"></script>

        <style>
            #canvas-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1;
            }
            #post-it-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 2;
            }
            .post-it {
                position: absolute;
                width: 200px;
                height: 150px;
                background-color: yellow;
                border: 2px solid black;
                resize: both;
                overflow: hidden;
            }
        </style>

    </head>
    <body>
        <nav id="nav">
            <a href="/" id="nav-title">TheRewrite</a>
        </nav>
        <section id="content">
            <div id="pdfCanvasContainer"></div>
            <div id="canvas-container">
                <canvas id="canvas"></canvas>
            </div>
            <div id="post-it-container"></div>
        </section>
        <script>

            const { pdfjsLib } = globalThis;

            pdfjsLib.GlobalWorkerOptions.workerSrc = '/script/pdf.worker.min.js';

            let canvas;
            let postItContainer;
            let isDrawing = false;
            let postItId = 0;

            window.onload = () => {
                let path = window.location.pathname;
                let pathArr = path.split("/");

                let canvasContainer = document.querySelector("#pdfCanvasContainer");
                canvas = document.getElementById("canvas");
                let loadingTask = pdfjsLib.getDocument("/pdf/get/" + pathArr[pathArr.length - 1]);

                loadingTask.promise
                    .then((pdf) => {

                        for(let i = 0; i <= pdf.numPages; i++) {
                            renderPage(pdf, canvasContainer, i);
                        }

                    })
                    .catch(() => {
                        window.location.replace("/");
                    });
            }

            function renderPage(pdf, canvasContainer, pageNr) {
                pdf.getPage(pageNr).then((page) => {
                    const scale = 3;
                    let viewport = page.getViewport({ scale: scale, });
                    let outputScale = window.devicePixelRatio || 1;

                    let canvas = document.createElement("canvas")
                    let context = canvas.getContext('2d');

                    canvas.id = "pdfCanvasPage-" + pageNr;
                    canvas.className = "pdfCanvas";
                    canvas.width = Math.floor(viewport.width * outputScale);
                    canvas.height = Math.floor(viewport.height * outputScale);

                    let transform = outputScale !== 1
                        ? [outputScale, 0, 0, outputScale, 0, 0]
                        : null;

                    let renderContext = {
                        canvasContext: context,
                        transform: transform,
                        viewport: viewport
                    };
                    page.render(renderContext);

                    canvasContainer.appendChild(canvas);
                });
            }

            canvas.addEventListener("mousedown", (e) => {
                isDrawing = true;
                const postIt = createPostIt(e.clientX, e.clientY);
                postItContainer.appendChild(postIt);
                e.preventDefault();
            });

            function createPostIt(x, y) {
                const postIt = document.createElement("div");
                postIt.classList.add("post-it");
                postIt.id = "post-it-" + postItId;
                postIt.style.left = x + "px";
                postIt.style.top = y + "px";
                postItId++;
                return postIt;
            }

            function movePostIt(x, y) {
                const postIt = document.querySelector(".post-it");
                if (postIt) {
                    postIt.style.left = x + "px";
                    postIt.style.top = y + "px";
                }
            }
        </script>
    </body>
</html>
